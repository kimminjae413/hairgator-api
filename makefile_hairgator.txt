# Makefile for Hairgator System v5.0
# ê°œë°œ ë° ë°°í¬ë¥¼ ìœ„í•œ í¸ì˜ ëª…ë ¹ì–´

.PHONY: help install dev test build deploy clean logs restart status

# ê¸°ë³¸ ì„¤ì •
PYTHON := python3
PIP := pip3
DOCKER_COMPOSE := docker-compose

# ìƒ‰ìƒ ì¶œë ¥
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

# ê¸°ë³¸ íƒ€ê²Ÿ
help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ í‘œì‹œ
	@echo "ğŸ¨ í—¤ì–´ê²Œì´í„° ì‹œìŠ¤í…œ v5.0 - ê°œë°œ ë„êµ¬"
	@echo ""
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  ${BLUE}%-15s${NC} %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""

# ê°œë°œ í™˜ê²½ ì„¤ì •
install: ## Python ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "${BLUE}ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...${NC}"
	$(PIP) install -r requirements_v5.txt
	@echo "${GREEN}âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ${NC}"

install-dev: ## ê°œë°œìš© ì˜ì¡´ì„± ì¶”ê°€ ì„¤ì¹˜
	@echo "${BLUE}ğŸ“¦ ê°œë°œìš© ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...${NC}"
	$(PIP) install -r requirements_v5.txt
	$(PIP) install pytest pytest-asyncio black flake8 mypy
	@echo "${GREEN}âœ… ê°œë°œìš© ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ${NC}"

setup: ## ì´ˆê¸° í™˜ê²½ ì„¤ì •
	@echo "${BLUE}ğŸ”§ ì´ˆê¸° í™˜ê²½ ì„¤ì • ì¤‘...${NC}"
	mkdir -p static/temp logs ssl
	chmod 755 static static/temp
	@if [ ! -f .env ]; then \
		echo "${YELLOW}âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. env_setup_v5.shë¥¼ ì°¸ê³ í•˜ì—¬ ìƒì„±í•˜ì„¸ìš”.${NC}"; \
		cp env_setup_v5.sh .env.example; \
	fi
	@echo "${GREEN}âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ${NC}"

# ê°œë°œ ì„œë²„
dev: ## ê°œë°œ ì„œë²„ ì‹œì‘ (Hot reload)
	@echo "${BLUE}ğŸš€ ê°œë°œ ì„œë²„ ì‹œì‘ ì¤‘...${NC}"
	$(PYTHON) -m uvicorn hairgator_integrated_v5:app --host 0.0.0.0 --port 8000 --reload

dev-redis: ## Redisì™€ í•¨ê»˜ ê°œë°œ ì„œë²„ ì‹œì‘
	@echo "${BLUE}ğŸš€ Redisì™€ ê°œë°œ ì„œë²„ ì‹œì‘ ì¤‘...${NC}"
	@if ! pgrep redis-server > /dev/null; then \
		echo "${YELLOW}Redis ì‹œì‘ ì¤‘...${NC}"; \
		redis-server --daemonize yes; \
	fi
	$(PYTHON) hairgator_integrated_v5.py

# í…ŒìŠ¤íŠ¸
test: ## API í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "${BLUE}ğŸ§ª API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...${NC}"
	$(PYTHON) test_hairgator_api.py

test-unit: ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (pytest)
	@echo "${BLUE}ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...${NC}"
	pytest tests/ -v

test-health: ## í—¬ìŠ¤ ì²´í¬ë§Œ í…ŒìŠ¤íŠ¸
	@echo "${BLUE}ğŸ’“ í—¬ìŠ¤ ì²´í¬ í…ŒìŠ¤íŠ¸ ì¤‘...${NC}"
	$(PYTHON) test_hairgator_api.py --test health

test-chat: ## ì±„íŒ… ê¸°ëŠ¥ë§Œ í…ŒìŠ¤íŠ¸
	@echo "${BLUE}ğŸ’¬ ì±„íŒ… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì¤‘...${NC}"
	$(PYTHON) test_hairgator_api.py --test chat

test-image: ## ì´ë¯¸ì§€ ë¶„ì„ë§Œ í…ŒìŠ¤íŠ¸
	@echo "${BLUE}ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¶„ì„ í…ŒìŠ¤íŠ¸ ì¤‘...${NC}"
	$(PYTHON) test_hairgator_api.py --test image

# ì½”ë“œ í’ˆì§ˆ
lint: ## ì½”ë“œ ë¦°íŒ… (flake8)
	@echo "${BLUE}ğŸ” ì½”ë“œ ë¦°íŒ… ì¤‘...${NC}"
	flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
	flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

format: ## ì½”ë“œ í¬ë§·íŒ… (black)
	@echo "${BLUE}ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘...${NC}"
	black .

type-check: ## íƒ€ì… ì²´í¬ (mypy)
	@echo "${BLUE}ğŸ” íƒ€ì… ì²´í¬ ì¤‘...${NC}"
	mypy . --ignore-missing-imports

# Docker ê´€ë ¨
build: ## Docker ì´ë¯¸ì§€ ë¹Œë“œ
	@echo "${BLUE}ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) build

deploy: ## ì „ì²´ ì‹œìŠ¤í…œ ë°°í¬
	@echo "${BLUE}ğŸš€ ì‹œìŠ¤í…œ ë°°í¬ ì¤‘...${NC}"
	./deploy.sh

up: ## Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
	@echo "${BLUE}â¬†ï¸ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) up -d

down: ## Docker Composeë¡œ ì„œë¹„ìŠ¤ ì¤‘ì§€
	@echo "${BLUE}â¬‡ï¸ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) down

restart: ## ì„œë¹„ìŠ¤ ì¬ì‹œì‘
	@echo "${BLUE}ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) restart

logs: ## ë¡œê·¸ í™•ì¸
	@echo "${BLUE}ğŸ“‹ ë¡œê·¸ í™•ì¸ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) logs -f

status: ## ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
	@echo "${BLUE}ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) ps

# ìœ ì§€ë³´ìˆ˜
clean: ## ì„ì‹œ íŒŒì¼ ë° ìºì‹œ ì •ë¦¬
	@echo "${BLUE}ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘...${NC}"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache .mypy_cache .coverage htmlcov/
	@echo "${GREEN}âœ… ì •ë¦¬ ì™„ë£Œ${NC}"

clean-docker: ## Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
	@echo "${BLUE}ğŸ³ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘...${NC}"
	$(DOCKER_COMPOSE) down --volumes --rmi all
	docker system prune -af
	@echo "${GREEN}âœ… Docker ì •ë¦¬ ì™„ë£Œ${NC}"

clean-all: clean clean-docker ## ëª¨ë“  ì„ì‹œ íŒŒì¼ ë° Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
	@echo "${GREEN}âœ… ì „ì²´ ì •ë¦¬ ì™„ë£Œ${NC}"

# SSL ì¸ì¦ì„œ
ssl-cert: ## ê°œë°œìš© SSL ì¸ì¦ì„œ ìƒì„±
	@echo "${BLUE}ğŸ” SSL ì¸ì¦ì„œ ìƒì„± ì¤‘...${NC}"
	@mkdir -p ssl
	openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
		-keyout ssl/server.key \
		-out ssl/server.crt \
		-subj "/C=KR/ST=Seoul/L=Seoul/O=Hairgator/CN=localhost"
	@echo "${GREEN}âœ… SSL ì¸ì¦ì„œ ìƒì„± ì™„ë£Œ${NC}"

# ë°±ì—… ë° ë³µì›
backup: ## ë°ì´í„° ë°±ì—…
	@echo "${BLUE}ğŸ’¾ ë°ì´í„° ë°±ì—… ì¤‘...${NC}"
	@mkdir -p backups
	@DATE=$$(date +%Y%m%d_%H%M%S); \
	tar -czf "backups/hairgator_backup_$$DATE.tar.gz" \
		static/ logs/ .env í—¤ì–´ê²Œì´í„°\ ìŠ¤íƒ€ì¼\ ë©”ë‰´\ í…ìŠ¤íŠ¸_women_rag_v2.xlsx || true
	@echo "${GREEN}âœ… ë°±ì—… ì™„ë£Œ - backups/ í´ë” í™•ì¸${NC}"

# ëª¨ë‹ˆí„°ë§
monitor: ## ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
	@echo "${BLUE}ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§${NC}"
	@echo "Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
	$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "Docker ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
	docker stats --no-stream
	@echo ""
	@echo "Redis ìƒíƒœ:"
	@redis-cli ping 2>/dev/null || echo "Redis ì—°ê²° ì‹¤íŒ¨"

# ê°œë°œ ë„êµ¬
shell: ## ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ì…¸ ì ‘ì†
	@echo "${BLUE}ğŸš ì»¨í…Œì´ë„ˆ ì…¸ ì ‘ì† ì¤‘...${NC}"
	$(DOCKER_COMPOSE) exec hairgator-app /bin/bash

redis-cli: ## Redis CLI ì ‘ì†
	@echo "${BLUE}ğŸ”„ Redis CLI ì ‘ì† ì¤‘...${NC}"
	$(DOCKER_COMPOSE) exec redis redis-cli

# ì—…ë°ì´íŠ¸
update-deps: ## ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
	@echo "${BLUE}â¬†ï¸ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì¤‘...${NC}"
	$(PIP) list --outdated
	$(PIP) freeze > requirements_backup.txt
	@echo "${YELLOW}requirements_backup.txtì— í˜„ì¬ ì˜ì¡´ì„±ì„ ë°±ì—…í–ˆìŠµë‹ˆë‹¤.${NC}"

# í”„ë¡œë•ì…˜ ë°°í¬
prod-deploy: ## í”„ë¡œë•ì…˜ ë°°í¬ (ì£¼ì˜!)
	@echo "${RED}âš ï¸ í”„ë¡œë•ì…˜ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!${NC}"
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/N]: " confirm && [ $$confirm = y ]
	@echo "${BLUE}ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì¤‘...${NC}"
	ENVIRONMENT=production $(DOCKER_COMPOSE) -f docker-compose.yml -f docker-compose.prod.yml up --build -d
	@echo "${GREEN}âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ${NC}"

# ë¹ ë¥¸ ëª…ë ¹ì–´ ë³„ì¹­
dev-quick: setup dev-redis ## ë¹ ë¥¸ ê°œë°œ í™˜ê²½ ì‹œì‘

all-tests: test test-unit ## ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰

full-deploy: clean build deploy test ## ì „ì²´ ë°°í¬ í”Œë¡œìš°

# ì •ë³´ í‘œì‹œ
info: ## ì‹œìŠ¤í…œ ì •ë³´ í‘œì‹œ
	@echo "${BLUE}ğŸ¨ í—¤ì–´ê²Œì´í„° ì‹œìŠ¤í…œ v5.0${NC}"
	@echo "Python: $$($(PYTHON) --version)"
	@echo "Docker: $$(docker --version)"
	@echo "Docker Compose: $$($(DOCKER_COMPOSE) --version)"
	@echo "Redis: $$(redis-server --version | head -1)"
	@echo ""
	@echo "í”„ë¡œì íŠ¸ êµ¬ì¡°:"
	@tree -L 2 -I '__pycache__|*.pyc|.git' . || ls -la